<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Northstar FPS: Oni Hunter</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #0f0f0f;
            color: #d4d4d4;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
            overflow: hidden;
        }

        .game-wrapper {
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9);
            border: 4px solid #444;
            border-radius: 4px;
            overflow: hidden;
            background: #000;
            width: 800px;
            height: 600px;
        }

        canvas {
            display: block;
            background: #000;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        /* UI Overlay */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 10;
        }

        .ui-group { display: flex; flex-direction: column; gap: 5px; }
        .bar-container { margin-bottom: 5px; }
        .bar-label { font-size: 16px; font-weight: bold; margin-bottom: 2px; color: #fff; text-shadow: 2px 2px 0 #000; }
        
        .hp-bar-bg { width: 220px; height: 12px; background-color: #333; border: 2px solid #000; }
        .hp-bar-fill { height: 100%; background-color: #dc2626; width: 100%; transition: width 0.1s; }
        .tal-bar-fill { height: 100%; background-color: #fbbf24; width: 100%; transition: width 0.1s; }
        .clam-bar-fill { height: 100%; background-color: #14b8a6; width: 100%; transition: width 0.1s; }
        
        .kill-count { font-size: 14px; color: #ccc; text-shadow: 1px 1px 0 #000; margin-top: 2px; }

        /* Screens */
        .message-box {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100;
        }
        
        .message-content { text-align: center; color: white; pointer-events: auto; }
        .message-content h1 { font-size: 3.5rem; margin-bottom: 0.5rem; color: #ef4444; text-shadow: 4px 4px 0 #000; font-weight: 900; letter-spacing: -2px;}
        .message-content p { font-size: 1.2rem; line-height: 1.5; color: #aaa; margin-bottom: 30px; }

        .btn {
            background: #991b1b; border: 2px solid #fff; color: white;
            padding: 20px 50px; font-size: 1.5rem; cursor: pointer;
            font-family: inherit; font-weight: bold; text-transform: uppercase;
            transition: all 0.1s;
            pointer-events: auto;
            box-shadow: 0 5px 0 #500;
        }
        .btn:hover { background: #dc2626; transform: translateY(-2px); box-shadow: 0 7px 0 #500; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #500; }
        
        #clamjumperUI { display: none; margin-top: 15px; }
        
        .controls-hint {
            position: absolute; bottom: 15px; left: 0; width: 100%;
            text-align: center; color: rgba(255,255,255,0.6); font-size: 0.9rem;
            z-index: 5; text-shadow: 2px 2px 0 #000; font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="game-wrapper">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div class="ui-overlay">
            <div class="ui-group">
                <div class="bar-container">
                    <div class="bar-label">NORTHSTAR</div>
                    <div class="hp-bar-bg"><div id="playerHpBar" class="hp-bar-fill"></div></div>
                    <div class="kill-count" id="playerKillCount">Demons Banished: 0</div>
                </div>
                <div class="bar-container" style="margin-top: 10px;">
                    <div class="bar-label" id="waveLabel" style="color:#fbbf24">WAVE 1</div>
                </div>
            </div>

            <div class="ui-group" style="align-items: flex-end;"> 
                <div class="bar-container" style="text-align: right;">
                    <div class="bar-label">TALAMASCA</div>
                    <div class="hp-bar-bg"><div id="talamascaHpBar" class="tal-bar-fill"></div></div>
                    <div class="kill-count" id="talamascaKillCount">Demons Banished: 0</div>
                </div>
                <div class="bar-container" id="clamjumperUI" style="text-align: right;">
                    <div class="bar-label">CLAMJUMPER</div>
                    <div class="hp-bar-bg"><div id="clamjumperHpBar" class="clam-bar-fill"></div></div>
                    <div class="kill-count" id="clamjumperKillCount">Demons Banished: 0</div>
                </div>
            </div>
        </div>

        <div class="controls-hint">WASD to Move | SPACE/CLICK to Swing | SHIFT to Block</div>

        <div id="messageBox" class="message-box">
            <div class="message-content">
                <h1 id="msgTitle">ONI HUNTER</h1>
                <p id="msgScore">
                    The gate is open.<br>Stand with Talamasca against the Horde.
                </p>
                <button id="restartBtn" class="btn">DRAW SWORD</button>
            </div>
        </div>
    </div>

    <script>
    // --- SAFE START WRAPPER ---
    window.onload = function() {
        
        // --- Global Variables ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        // Elements
        const ui = {
            playerHp: document.getElementById('playerHpBar'),
            talHp: document.getElementById('talamascaHpBar'),
            clamHp: document.getElementById('clamjumperHpBar'),
            clamDiv: document.getElementById('clamjumperUI'),
            pKill: document.getElementById('playerKillCount'),
            tKill: document.getElementById('talamascaKillCount'),
            cKill: document.getElementById('clamjumperKillCount'),
            wave: document.getElementById('waveLabel'),
            msgBox: document.getElementById('messageBox'),
            msgTitle: document.getElementById('msgTitle'),
            msgScore: document.getElementById('msgScore'),
            btn: document.getElementById('restartBtn')
        };

        // Constants
        const CONFIG = {
            PLAYER_SPEED: 200,
            ROTATION_SPEED: 3.0,
            FOV: 700,
            CAM_HEIGHT: 40,
            SWORD_RANGE: 150,
            SWORD_ARC: Math.PI / 1.4,
            ATTACK_DUR: 0.25,
            ATTACK_CD: 0.45,
            TAL_SPEED: 320
        };

        // Game State
        let state = {
            lastTime: 0,
            active: false,
            wave: 1,
            keys: {},
            mousePressed: false,
            animId: null
        };

        // Entities
        const player = { x: 0, y: 0, hp: 100, maxHp: 100, angle: -Math.PI/2, kills: 0, cooldown: 0, atkTimer: 0, isBlocking: false, dmg: 35 };
        const talamasca = { x: 50, y: 50, hp: 50, maxHp: 50, dead: false, kills: 0, color: '#ffd700', height: 140 };
        const clamjumper = { active: false, x: -50, y: 50, hp: 80, maxHp: 80, dead: false, kills: 0, color: '#0d9488', moveTimer: 0, height: 70 };
        
        let enemies = [];
        let env = [];
        let particles = [];

        // --- Input Handling ---
        window.addEventListener('keydown', e => state.keys[e.code] = true);
        window.addEventListener('keyup', e => state.keys[e.code] = false);
        
        canvas.addEventListener('mousedown', () => {
            if(state.active) {
                state.mousePressed = true;
                try { canvas.requestPointerLock(); } catch(e){}
            }
        });
        canvas.addEventListener('mouseup', () => state.mousePressed = false);

        // --- Core Functions ---

        function project(x, y, z, height) {
            const dx = x - player.x;
            const dy = y - player.y;
            const theta = -player.angle;
            
            const front = dx * Math.cos(theta) - dy * Math.sin(theta);
            const side = dx * Math.sin(theta) + dy * Math.cos(theta);

            if (front < 5) return null;

            const scale = CONFIG.FOV / front;
            const screenX = (canvas.width / 2) + (side * scale);
            const screenY = (canvas.height / 2) + (CONFIG.CAM_HEIGHT * scale); 
            const screenSize = height * scale;

            return { x: screenX, y: screenY, s: screenSize, dist: front };
        }

        function update(dt) {
            if (!state.active) return;

            // Player Turn
            if (state.keys['ArrowLeft'] || state.keys['KeyA']) player.angle -= CONFIG.ROTATION_SPEED * dt;
            if (state.keys['ArrowRight'] || state.keys['KeyD']) player.angle += CONFIG.ROTATION_SPEED * dt;

            // Player Move
            let spd = 0;
            if (state.keys['ArrowUp'] || state.keys['KeyW']) spd = CONFIG.PLAYER_SPEED;
            if (state.keys['ArrowDown'] || state.keys['KeyS']) spd = -CONFIG.PLAYER_SPEED * 0.5;

            if (spd !== 0) {
                const nx = player.x + Math.cos(player.angle) * spd * dt;
                const ny = player.y + Math.sin(player.angle) * spd * dt;
                let hit = false;
                env.forEach(e => {
                    const d = Math.sqrt((nx-e.x)**2 + (ny-e.y)**2);
                    if(d < e.radius + 15) hit = true;
                });
                if(!hit) { player.x = nx; player.y = ny; }
            }
            player.isBlocking = state.keys['ShiftLeft'] || state.keys['ShiftRight'];

            // Attack Logic
            if (player.cooldown > 0) player.cooldown -= dt;
            if ((state.keys['Space'] || state.mousePressed) && player.cooldown <= 0 && !player.isBlocking) {
                player.atkTimer = CONFIG.ATTACK_DUR;
                player.cooldown = CONFIG.ATTACK_CD;
                
                enemies.forEach(e => {
                    const dx = e.x - player.x;
                    const dy = e.y - player.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < CONFIG.SWORD_RANGE) {
                        const angTo = Math.atan2(dy, dx);
                        let diff = angTo - player.angle;
                        while (diff > Math.PI) diff -= Math.PI*2;
                        while (diff < -Math.PI) diff += Math.PI*2;

                        if (Math.abs(diff) < CONFIG.SWORD_ARC / 2) {
                            e.hp -= player.dmg;
                            e.x += Math.cos(player.angle) * 60;
                            e.y += Math.sin(player.angle) * 60;
                            particles.push({x:e.x, y:e.y, z:60, c:'#fff', life:0.2, s: 10});
                            
                            if(e.hp <= 0) {
                                e.dead = true;
                                player.kills++;
                                ui.pKill.innerText = `Demons Banished: ${player.kills}`;
                                particles.push({x:e.x, y:e.y, z:60, c:'#ef4444', life:0.6, s: 20});
                            }
                        }
                    }
                });
            }
            if(player.atkTimer > 0) player.atkTimer -= dt;

            // Manage Enemies
            enemies = enemies.filter(e => !e.dead);
            if(enemies.length === 0) { state.wave++; spawnWave(); }

            enemies.forEach(e => {
                let target = player;
                const dTal = !talamasca.dead ? Math.sqrt((e.x-talamasca.x)**2 + (e.y-talamasca.y)**2) : Infinity;
                const dPly = Math.sqrt((e.x-player.x)**2 + (e.y-player.y)**2);
                if(dTal < dPly) target = talamasca;

                const ang = Math.atan2(target.y - e.y, target.x - e.x);
                e.x += Math.cos(ang) * e.speed * dt;
                e.y += Math.sin(ang) * e.speed * dt;

                if(target === player && dPly < 40) {
                    if(player.isBlocking) {
                        e.x -= Math.cos(ang) * 200 * dt;
                        e.y -= Math.sin(ang) * 200 * dt;
                    } else {
                        player.hp -= 15 * dt;
                        ui.playerHp.style.width = `${player.hp}%`;
                        if(player.hp <= 0) gameOver();
                    }
                }
                if(target === talamasca && dTal < 40) {
                    talamasca.hp -= 15 * dt;
                    ui.talHp.style.width = `${(talamasca.hp/talamasca.maxHp)*100}%`;
                    if(talamasca.hp <= 0) {
                        talamasca.dead = true;
                        ui.talHp.style.width = '0%';
                    }
                }
            });

            if(!talamasca.dead) updateAlly(talamasca, dt, CONFIG.TAL_SPEED);
            if(clamjumper.active && !clamjumper.dead) updateClam(dt);
            particles.forEach((p,i) => { p.life -= dt; if(p.life<=0) particles.splice(i,1); });
        }

        function updateAlly(ally, dt, speed) {
            let target = null;
            let minDist = Infinity;
            enemies.forEach(e => {
                const d = Math.sqrt((e.x - ally.x)**2 + (e.y - ally.y)**2);
                if(d < minDist) { minDist = d; target = e; }
            });

            if(target && minDist < 600) {
                const ang = Math.atan2(target.y - ally.y, target.x - ally.x);
                if(minDist > 50) {
                    ally.x += Math.cos(ang) * speed * dt;
                    ally.y += Math.sin(ang) * speed * dt;
                } else {
                    target.hp -= 50 * dt;
                    if(target.hp <= 0) {
                        target.dead = true; ally.kills++;
                        ui.tKill.innerText = `Demons Banished: ${ally.kills}`;
                        particles.push({x:target.x, y:target.y, z:60, c:'#fbbf24', life:0.4, s:15});
                    }
                }
            } else {
                const leadX = player.x + Math.cos(player.angle) * 200;
                const leadY = player.y + Math.sin(player.angle) * 200;
                const d = Math.sqrt((leadX-ally.x)**2 + (leadY-ally.y)**2);
                if(d > 50) {
                    const ang = Math.atan2(leadY - ally.y, leadX - ally.x);
                    ally.x += Math.cos(ang) * speed * 1.1 * dt;
                    ally.y += Math.sin(ang) * speed * 1.1 * dt;
                }
            }
        }

        function updateClam(dt) {
             clamjumper.moveTimer -= dt;
             if (clamjumper.moveTimer <= 0) {
                 clamjumper.ang = Math.random() * Math.PI * 2;
                 clamjumper.moveTimer = 1.0;
             }
             let target = null;
             enemies.forEach(e => {
                 const d = Math.sqrt((e.x - clamjumper.x)**2 + (e.y - clamjumper.y)**2);
                 if(d < 250) target = e; 
             });

             if (target) {
                 const ang = Math.atan2(target.y - clamjumper.y, target.x - clamjumper.x);
                 const d = Math.sqrt((target.x-clamjumper.x)**2 + (target.y-clamjumper.y)**2);
                 if (d > 40) {
                    clamjumper.x += Math.cos(ang) * 160 * dt;
                    clamjumper.y += Math.sin(ang) * 160 * dt;
                 } else {
                    target.hp -= 30 * dt;
                    if (target.hp <= 0) { target.dead = true; clamjumper.kills++; }
                 }
             } else {
                 clamjumper.x += Math.cos(clamjumper.ang) * 160 * dt;
                 clamjumper.y += Math.sin(clamjumper.ang) * 160 * dt;
             }
        }

        // --- Drawing (The Artist) ---
        function draw() {
            // Sky
            const grdSky = ctx.createLinearGradient(0,0,0,canvas.height/2);
            grdSky.addColorStop(0, "#020617");
            grdSky.addColorStop(1, "#1e293b");
            ctx.fillStyle = grdSky; ctx.fillRect(0, 0, canvas.width, canvas.height/2);

            // Ground
            const grdGnd = ctx.createLinearGradient(0, canvas.height/2, 0, canvas.height);
            grdGnd.addColorStop(0, "#1c1917");
            grdGnd.addColorStop(1, "#0c0a09");
            ctx.fillStyle = grdGnd; ctx.fillRect(0, canvas.height/2, canvas.width, canvas.height/2);

            let renderList = [];

            // Add Items to List
            env.forEach(e => {
                const p = project(e.x, e.y, 0, e.height);
                if(p) renderList.push({...p, type:'env', c: e.type==='tree'?'#14532d':'#44403c'});
            });

            enemies.forEach(e => {
                const p = project(e.x, e.y, 0, e.height);
                if(p) renderList.push({...p, type:'enemy', hp: e.hp/e.maxHp});
            });

            if(!talamasca.dead) {
                const p = project(talamasca.x, talamasca.y, 0, talamasca.height);
                if(p) renderList.push({...p, type:'ally', c: talamasca.color});
            }
            if(clamjumper.active && !clamjumper.dead) {
                const p = project(clamjumper.x, clamjumper.y, 0, clamjumper.height);
                if(p) renderList.push({...p, type:'clam', c: clamjumper.color});
            }
            
            particles.forEach(pt => {
                 const p = project(pt.x, pt.y, pt.z, pt.s || 20);
                 if(p) renderList.push({...p, type:'part', c: pt.c});
            });

            // Painter's Algorithm (Sort by distance)
            renderList.sort((a,b) => b.dist - a.dist);

            // DRAW LOOP
            renderList.forEach(item => {
                const footY = item.y; 
                const s = item.s;
                const x = item.x;
                
                if(item.type === 'env') {
                    ctx.fillStyle = item.c;
                    ctx.beginPath();
                    // Stylized Tree/Rock
                    if(item.c === '#14532d') { // Tree
                        ctx.moveTo(x, footY - s);
                        ctx.lineTo(x + s*0.4, footY);
                        ctx.lineTo(x - s*0.4, footY);
                    } else { // Rock
                        ctx.ellipse(x, footY - s/4, s/2, s/4, 0, 0, Math.PI*2);
                    }
                    ctx.fill();
                } 
                else if(item.type === 'enemy') {
                    // --- ONI DRAWING ---
                    const w = s * 0.45;
                    const top = footY - s;

                    // Body (Red Demon Skin)
                    ctx.fillStyle = '#991b1b'; 
                    ctx.fillRect(x - w/2, top, w, s);
                    
                    // Loincloth (Tiger Print)
                    ctx.fillStyle = '#fbbf24';
                    ctx.fillRect(x - w/2, top + s*0.6, w, s*0.15);
                    ctx.fillStyle = '#000'; // Stripes
                    ctx.beginPath();
                    ctx.moveTo(x, top + s*0.6); ctx.lineTo(x - w*0.1, top+s*0.75);
                    ctx.moveTo(x-w*0.3, top + s*0.6); ctx.lineTo(x - w*0.4, top+s*0.75);
                    ctx.moveTo(x+w*0.3, top + s*0.6); ctx.lineTo(x + w*0.4, top+s*0.75);
                    ctx.stroke();

                    // Kanabo (Club) on side
                    ctx.fillStyle = '#292524';
                    ctx.fillRect(x + w*0.55, top + s*0.3, w*0.15, s*0.5);

                    // Head/Face
                    const headSize = w * 0.9;
                    const headTop = top + s*0.05;
                    ctx.fillStyle = '#b91c1c'; // Slightly brighter head
                    ctx.fillRect(x - headSize/2, headTop, headSize, headSize);

                    // Horns
                    ctx.fillStyle = '#fef08a';
                    ctx.beginPath();
                    ctx.moveTo(x - headSize*0.3, headTop); ctx.lineTo(x - headSize*0.4, headTop - headSize*0.4); ctx.lineTo(x - headSize*0.1, headTop);
                    ctx.moveTo(x + headSize*0.3, headTop); ctx.lineTo(x + headSize*0.4, headTop - headSize*0.4); ctx.lineTo(x + headSize*0.1, headTop);
                    ctx.fill();

                    // Evil Eyes
                    ctx.fillStyle = '#facc15';
                    ctx.beginPath();
                    ctx.moveTo(x - headSize*0.3, headTop + headSize*0.3); ctx.lineTo(x - headSize*0.1, headTop + headSize*0.4); ctx.lineTo(x - headSize*0.3, headTop + headSize*0.4);
                    ctx.moveTo(x + headSize*0.3, headTop + headSize*0.3); ctx.lineTo(x + headSize*0.1, headTop + headSize*0.4); ctx.lineTo(x + headSize*0.3, headTop + headSize*0.4);
                    ctx.fill();

                    // Fangs
                    ctx.fillStyle = '#fff';
                    ctx.beginPath();
                    ctx.moveTo(x - headSize*0.2, headTop + headSize*0.7); ctx.lineTo(x - headSize*0.2, headTop + headSize*0.9); ctx.lineTo(x - headSize*0.1, headTop + headSize*0.7);
                    ctx.moveTo(x + headSize*0.2, headTop + headSize*0.7); ctx.lineTo(x + headSize*0.2, headTop + headSize*0.9); ctx.lineTo(x + headSize*0.1, headTop + headSize*0.7);
                    ctx.fill();

                    // HP Bar
                    ctx.fillStyle = 'red';
                    ctx.fillRect(x - w/2, top - 15, w * item.hp, 8);
                }
                else if(item.type === 'ally') {
                    // --- TALAMASCA (TALL HUMAN) ---
                    const w = s * 0.3; // Slimmer human proportions
                    const top = footY - s;
                    
                    // Robes (White/Gold)
                    ctx.fillStyle = '#e2e8f0';
                    ctx.fillRect(x - w/2, top + s*0.2, w, s*0.8);
                    
                    // Gold Sash
                    ctx.fillStyle = '#fbbf24';
                    ctx.fillRect(x - w/2, top + s*0.45, w, s*0.05);

                    // Head
                    ctx.fillStyle = '#fde68a'; // Skin
                    const headSize = w * 0.8;
                    ctx.fillRect(x - headSize/2, top, headSize, headSize);
                    
                    // Spiky Gold Hair
                    ctx.fillStyle = '#fbbf24';
                    ctx.beginPath();
                    ctx.moveTo(x - headSize*0.5, top);
                    ctx.lineTo(x - headSize*0.6, top - headSize*0.5);
                    ctx.lineTo(x, top - headSize*0.2);
                    ctx.lineTo(x + headSize*0.6, top - headSize*0.5);
                    ctx.lineTo(x + headSize*0.5, top);
                    ctx.fill();

                    // Eyes (Blue)
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillRect(x - headSize*0.2, top + headSize*0.4, 2, 2);
                    ctx.fillRect(x + headSize*0.2, top + headSize*0.4, 2, 2);
                }
                else if(item.type === 'clam') {
                    // Short Teal Guy
                    const w = s * 0.4;
                    ctx.fillStyle = item.c;
                    ctx.fillRect(x - w/2, footY - s, w, s);
                    // Beanie
                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath(); ctx.arc(x, footY - s, w/2, Math.PI, 0); ctx.fill();
                    // Pom pom
                    ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(x, footY - s - w/2, w/4, 0, Math.PI*2); ctx.fill();
                }
                else if(item.type === 'part') {
                    ctx.fillStyle = item.c;
                    ctx.fillRect(x, footY - s, s, s);
                }
            });

            drawWeapon();
            drawCrosshair();
        }

        function drawWeapon() {
            ctx.save();
            let tx = canvas.width * 0.7;
            let ty = canvas.height;
            let rot = 0;
            
            // Walking Sway
            tx += Math.sin(Date.now() / 200) * 5;

            if(player.atkTimer > 0) {
                // Swing Animation
                const prog = 1 - (player.atkTimer / CONFIG.ATTACK_DUR);
                tx -= prog * 200;
                ty += Math.sin(prog * Math.PI) * 100;
                rot = -0.5 - (Math.sin(prog * Math.PI) * 1.5);
            } else if (player.isBlocking) {
                // Block Animation
                tx = canvas.width/2; 
                ty = canvas.height - 20; 
                rot = -Math.PI/4;
            }

            ctx.translate(tx, ty);
            ctx.rotate(rot);

            // Katana Style
            ctx.fillStyle = player.isBlocking ? '#fef08a' : '#e2e8f0'; 
            ctx.fillRect(-15, -350, 30, 350); // Blade
            ctx.fillStyle = '#1e1b4b'; ctx.fillRect(-20, 0, 40, 60); // Handle
            ctx.fillStyle = '#ca8a04'; ctx.fillRect(-35, -10, 70, 10); // Guard
            ctx.restore();
        }

        function drawCrosshair() {
            const cx = canvas.width/2; const cy = canvas.height/2;
            ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 2;
            ctx.beginPath(); 
            ctx.moveTo(cx-12, cy); ctx.lineTo(cx+12, cy);
            ctx.moveTo(cx, cy-12); ctx.lineTo(cx, cy+12);
            ctx.stroke();
        }

        function generateEnv() {
            env = [];
            for(let i=0; i<40; i++) {
                const type = Math.random() < 0.2 ? 'rock' : 'tree';
                const h = type==='tree' ? 350 : 60;
                const ex = (Math.random()-0.5)*2000;
                const ey = (Math.random()-0.5)*2000;
                env.push({type, x:ex, y:ey, radius:40, height:h});
            }
        }

        function spawnWave() {
            ui.wave.innerText = `WAVE ${state.wave}`;
            const count = 5 + state.wave * 2;
            
            if(!clamjumper.active && Math.random() < 0.2) {
                clamjumper.active = true;
                clamjumper.x = player.x + 100; clamjumper.y = player.y;
                ui.clamDiv.style.display = 'block';
            }

            for(let i=0; i<count; i++) {
                const ang = Math.random() * Math.PI * 2;
                const dist = 700 + Math.random() * 400;
                enemies.push({
                    x: player.x + Math.cos(ang) * dist,
                    y: player.y + Math.sin(ang) * dist,
                    speed: 95 + (state.wave * 5),
                    hp: 35 + (state.wave * 10),
                    maxHp: 35 + (state.wave * 10),
                    height: 100, dead: false // Standard Oni Height
                });
            }
        }

        function gameOver() {
            state.active = false;
            ui.msgTitle.innerText = "DEFEAT";
            ui.msgTitle.style.color = "#991b1b";
            ui.msgScore.innerHTML = `You survived ${state.wave-1} waves.<br>Demons Banished: ${player.kills}`;
            ui.btn.innerText = "TRY AGAIN";
            ui.msgBox.style.display = 'flex';
        }

        // --- GLOBAL START FUNCTION ---
        function startGame() {
            if(state.animId) cancelAnimationFrame(state.animId);

            // Reset Logic
            player.hp = 100; player.x = 0; player.y = 0; player.angle = -Math.PI/2; player.kills = 0;
            talamasca.hp = 50; talamasca.dead = false; talamasca.x = 50; talamasca.y = 50;
            clamjumper.active = false; ui.clamDiv.style.display = 'none';
            enemies = []; particles = []; state.wave = 1;
            
            ui.playerHp.style.width = '100%';
            ui.talHp.style.width = '100%';
            ui.pKill.innerText = "Demons Banished: 0";
            ui.msgBox.style.display = 'none';

            generateEnv();
            spawnWave();
            state.active = true;
            state.lastTime = performance.now();
            loop(state.lastTime);
        };

        function loop(timestamp) {
            const dt = (timestamp - state.lastTime) / 1000;
            state.lastTime = timestamp;

            if (dt < 0.2) {
                update(dt);
                draw();
            }
            
            state.animId = requestAnimationFrame(loop);
        }
        
        // Attach Event Listener Safely
        ui.btn.addEventListener('click', startGame);

        generateEnv();
        draw();
    };
    </script>
</body>
</html>